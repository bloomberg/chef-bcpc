###############################################################################
#                             generated by chef
###############################################################################

global
  daemon
  user haproxy
  group haproxy
  pidfile /var/run/haproxy.pid
  stats socket /var/run/haproxy/haproxy.asok level admin
  log /dev/log local0 info alert
  maxconn 8000

defaults
  log global
  mode http
  option http-server-close
  option abortonclose
  option tcplog
  option dontlognull
  option redispatch
  retries 3
  timeout http-request 10s
  timeout queue 1m
  timeout connect 5s
  timeout check 10s
  timeout client 30m
  timeout server 30m

listen keystone-admin-api
  bind <%= @vip %>:35357 ssl crt /etc/haproxy/haproxy.pem
  option tcpka
  option httpchk
  option tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:35357 check inter 5s rise 1 fall 1
<% end -%>

listen keystone-public-api
  bind <%= @vip %>:5000 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcpka
  option httpchk
  option tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:5000 check inter 5s rise 1 fall 1
<% end -%>

listen glance-api
  bind <%= @vip %>:9292 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcpka
  option httpchk
  option tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:9292 check inter 5s rise 1 fall 1
<% end -%>

listen cinder-api
  bind <%= @vip %>:8776 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option  tcpka
  option  httpchk
  option  tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:8776 check inter 5s rise 1 fall 1
<% end -%>

listen nova-api
  bind <%= @vip %>:8774 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option  tcpka
  option  httpchk
  option  tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:8774 check inter 5s rise 1 fall 1
<% end -%>

listen nova-metadata-api
  bind <%= @vip %>:8775 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcpka
  option tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:8775 check inter 5s rise 1 fall 1
<% end -%>

listen placement-api
  bind <%= @vip %>:8778 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcplog
  option httpchk GET /
  http-check expect status 200
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:8778 check inter 5s rise 1 fall 1
<% end -%>

listen neutron-api
  bind <%= @vip %>:9696 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcpka
  option httpchk
  option tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:9696 check inter 5s rise 1 fall 1
<% end -%>

listen heat-api
  bind <%= @vip %>:8004 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcplog
  option httpchk GET /
  http-check expect status 300
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:8004 check inter 5s rise 1 fall 1
<% end -%>

listen heat-api-cfn
  bind <%= @vip %>:8000 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcplog
  option httpchk GET /
  http-check expect status 300
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:8000 check inter 5s rise 1 fall 1
<% end -%>

listen novncproxy
  bind <%= @vip %>:6080 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcpka
  option tcplog
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:6080 check inter 5s rise 1 fall 1
<% end -%>

frontend http
  bind <%= @vip %>:80
  option tcplog
  default_backend http-backend

frontend https
  bind <%= @vip %>:443 ssl crt /etc/haproxy/haproxy.pem
  option tcplog
  stats enable
  stats uri /haproxy
  stats hide-version
  stats realm Haproxy\ Statistics
  stats auth <%= @user['username'] %>:<%= @user['password'] %>
  reqadd X-Forwarded-Proto:\ https
  acl url_horizon path_beg /horizon
  use_backend horizon-backend if url_horizon
  acl url_horizon_static path_beg /static
  use_backend horizon-backend if url_horizon_static
  acl url_rabbitmq path_beg /rabbitmq
  use_backend rabbitmq-web-backend if url_rabbitmq
  default_backend http-backend

backend http-backend
  balance source
  option httpchk GET /
  http-check expect status 200
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:80 check inter 5s rise 1 fall 1
<% end -%>

backend horizon-backend
  balance source
  option httpchk GET /
  http-check expect status 200
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:9999 check inter 5s rise 1 fall 1
<% end -%>

backend rabbitmq-web-backend
  balance source
  option httpchk GET /
  http-check expect status 200
  reqrep ^([^\ :]*)\ /rabbitmq/(.*) \1\ /\2
<% @nodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['ipaddress'] %>:55672 check inter 5s rise 1 fall 1
<% end -%>
