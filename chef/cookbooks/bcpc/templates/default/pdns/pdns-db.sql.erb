CREATE DATABASE IF NOT EXISTS <%= @pdns_db %>;

GRANT ALL PRIVILEGES ON <%= @pdns_db %>.* TO '<%= @pdns_db_user %>'@'localhost' \
IDENTIFIED BY '<%= @pdns_db_password %>';

GRANT ALL PRIVILEGES ON <%= @pdns_db %>.* TO '<%= @pdns_db_user %>'@'%' \
IDENTIFIED BY '<%= @pdns_db_password %>';

GRANT ALL PRIVILEGES ON <%= @nova_db %>.* TO '<%= @pdns_db_user %>'@'localhost' \
IDENTIFIED BY '<%= @pdns_db_password %>';

GRANT ALL PRIVILEGES ON <%= @nova_db %>.* TO '<%= @pdns_db_user %>'@'%' \
IDENTIFIED BY '<%= @pdns_db_password %>';

USE <%= @pdns_db %>;


CREATE TABLE IF NOT EXISTS domains (
  id                    INT AUTO_INCREMENT,
  name                  VARCHAR(255) NOT NULL,
  master                VARCHAR(128) DEFAULT NULL,
  last_check            INT DEFAULT NULL,
  type                  VARCHAR(6) NOT NULL,
  notified_serial       INT DEFAULT NULL,
  account               VARCHAR(40) DEFAULT NULL,
  PRIMARY KEY (id)
) Engine=InnoDB;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'domains' AND index_name LIKE 'name_index'
    )
    ,'SELECT ''index name_index exists'';'
    ,'CREATE UNIQUE INDEX name_index ON domains(name)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

CREATE TABLE IF NOT EXISTS records (
  id                    BIGINT AUTO_INCREMENT,
  domain_id             INT DEFAULT NULL,
  name                  VARCHAR(255) DEFAULT NULL,
  type                  VARCHAR(10) DEFAULT NULL,
  content               TEXT DEFAULT NULL,
  ttl                   INT DEFAULT 300,
  prio                  INT DEFAULT NULL,
  change_date           INT DEFAULT NULL,
  disabled              TINYINT(1) DEFAULT 0,
  ordername             VARCHAR(255) BINARY DEFAULT NULL,
  auth                  TINYINT(1) DEFAULT 1,
  bcpc_record_type      VARCHAR(32),
  PRIMARY KEY (id)
) Engine=InnoDB;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'records' AND index_name LIKE 'nametype_index'
    )
    ,'SELECT ''index nametype_index exists'';'
    ,'CREATE INDEX nametype_index ON records(name,type)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'records' AND index_name LIKE 'domain_id'
    )
    ,'SELECT ''index domain_id exists'';'
    ,'CREATE INDEX domain_id ON records(domain_id)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'records' AND index_name LIKE 'recordorder'
    )
    ,'SELECT ''index recordorder exists'';'
    ,'CREATE INDEX recordorder ON records(domain_id, ordername)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- This unique index exists in order to facilitate the use of INSERT INTO ON DUPLICATE KEY UPDATE for doing non-destructive inserts/updates
-- change_date is intentionally not included so that it will not be considered as part of the record itself when determining uniqueness
-- prio is also not included because it is NULL in all cases for us and this apparently confuses MySQL into thinking that the INSERT is always unique when it's not
SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'records' AND index_name LIKE 'records_all_fields_idx'
    )
    ,'SELECT ''index records_all_fields_idx exists'';'
    ,'CREATE INDEX records_all_fields_idx ON records(domain_id, name, type, content(20), ttl, bcpc_record_type)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

CREATE TABLE IF NOT EXISTS supermasters (
  ip                    VARCHAR(64) NOT NULL,
  nameserver            VARCHAR(255) NOT NULL,
  account               VARCHAR(40) NOT NULL,
  PRIMARY KEY (ip, nameserver)
) Engine=InnoDB;


CREATE TABLE IF NOT EXISTS comments (
  id                    INT AUTO_INCREMENT,
  domain_id             INT NOT NULL,
  name                  VARCHAR(255) NOT NULL,
  type                  VARCHAR(10) NOT NULL,
  modified_at           INT NOT NULL,
  account               VARCHAR(40) NOT NULL,
  comment               TEXT NOT NULL,
  PRIMARY KEY (id)
) Engine=InnoDB;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'comments' AND index_name LIKE 'comments_domain_id_idx'
    )
    ,'SELECT ''index comments_domain_id_idx exists'';'
    ,'CREATE INDEX comments_domain_id_idx ON comments(domain_id)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'comments' AND index_name LIKE 'comments_name_type_idx'
    )
    ,'SELECT ''index comments_name_type_idx exists'';'
    ,'CREATE INDEX comments_name_type_idx ON comments(name, type)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'comments' AND index_name LIKE 'comments_order_idx'
    )
    ,'SELECT ''index comments_order_idx exists'';'
    ,'CREATE INDEX comments_order_idx ON comments(domain_id, modified_at)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;


CREATE TABLE IF NOT EXISTS domainmetadata (
  id                    INT AUTO_INCREMENT,
  domain_id             INT NOT NULL,
  kind                  VARCHAR(32),
  content               TEXT,
  PRIMARY KEY (id)
) Engine=InnoDB;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'domainmetadata' AND index_name LIKE 'domainmetadata_idx'
    )
    ,'SELECT ''index domainmetadata_idx exists'';'
    ,'CREATE INDEX domainmetadata_idx ON domainmetadata(domain_id, kind)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;


CREATE TABLE IF NOT EXISTS cryptokeys (
  id                    INT AUTO_INCREMENT,
  domain_id             INT NOT NULL,
  flags                 INT NOT NULL,
  active                BOOL,
  content               TEXT,
  PRIMARY KEY(id)
) Engine=InnoDB;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'cryptokeys' AND index_name LIKE 'domainidindex'
    )
    ,'SELECT ''index domaidindex exists'';'
    ,'CREATE INDEX domainidindex ON cryptokeys(domain_id)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;


CREATE TABLE IF NOT EXISTS tsigkeys (
  id                    INT AUTO_INCREMENT,
  name                  VARCHAR(255),
  algorithm             VARCHAR(50),
  secret                VARCHAR(255),
  PRIMARY KEY (id)
) Engine=InnoDB;

SELECT IF (
  EXISTS(
    SELECT 1 FROM information_schema.statistics
    WHERE table_schema = '<%= @pdns_db %>'
    AND table_name = 'tsigkeys' AND index_name LIKE 'namealgoindex'
    )
    ,'SELECT ''index namealgoindex exists'';'
    ,'CREATE UNIQUE INDEX namealgoindex ON tsigkeys(name, algorithm)') INTO @a;
PREPARE stmt FROM @a;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
