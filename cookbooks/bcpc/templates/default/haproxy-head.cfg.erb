################################################
#
#              Generated by Chef
#
################################################

global
  daemon
  user haproxy
  group haproxy
  pidfile /var/run/haproxy.pid
  stats socket /var/run/haproxy/haproxy.asok level admin
  log /dev/log local0 info alert
  maxconn 8000

defaults
  log global
  mode http
  option http-server-close
  option abortonclose
  option tcplog
  option dontlognull
  option redispatch
  retries 3
  timeout http-request 10s
  timeout queue 1m
  timeout connect 5s
  timeout check 10s
  timeout client 30m
  timeout server 30m

listen keystone-admin-api
  bind <%=node['bcpc']['management']['vip']%>:35357 <%= (node['bcpc']['protocol']['keystone'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  option tcpka
  option httpchk
  option tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:35357 check inter 5s rise 1 fall 1" %>
<% end -%>

listen keystone-public-api
  bind <%=node['bcpc']['management']['vip']%>:5000 <%= (node['bcpc']['protocol']['keystone'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcpka
  option httpchk
  option tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:5000 check inter 5s rise 1 fall 1" %>
<% end -%>

listen glance-api
  bind <%=node['bcpc']['management']['vip']%>:9292 <%= (node['bcpc']['protocol']['glance'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcpka
  option httpchk
  option tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:9292 check inter 5s rise 1 fall 1" %>
<% end -%>

listen cinder-api
  bind <%=node['bcpc']['management']['vip']%>:8776 <%= (node['bcpc']['protocol']['cinder'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option  tcpka
  option  httpchk
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:8776 check inter 5s rise 1 fall 1" %>
<% end -%>

listen nova-api
  bind <%=node['bcpc']['management']['vip']%>:8774 <%= (node['bcpc']['protocol']['nova'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option  tcpka
  option  httpchk
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:8774 check inter 5s rise 1 fall 1" %>
<% end -%>

listen nova-metadata-api
  bind <%=node['bcpc']['management']['vip']%>:8775 <%= (node['bcpc']['protocol']['nova'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcpka
  option tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:8775 check inter 5s rise 1 fall 1" %>
<% end -%>

listen placement-api
  bind <%=node['bcpc']['management']['vip']%>:8778 <%= (node['bcpc']['protocol']['nova'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcplog
  option httpchk GET /
  http-check expect status 200
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:8778 check inter 5s rise 1 fall 1" %>
<% end -%>

listen neutron-api
  bind <%=node['bcpc']['management']['vip']%>:9696 <%= (node['bcpc']['protocol']['neutron'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcpka
  option httpchk
  option tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:9696 check inter 5s rise 1 fall 1" %>
<% end %>

listen heat-api
  bind <%=node['bcpc']['management']['vip']%>:8004 <%= (node['bcpc']['protocol']['heat'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcplog
  option httpchk GET /
  http-check expect status 300
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:8004 check inter 5s rise 1 fall 1" %>
<% end -%>

listen heat-api-cfn
  bind <%=node['bcpc']['management']['vip']%>:8000 <%= (node['bcpc']['protocol']['heat'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcplog
  option httpchk GET /
  http-check expect status 300
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:8000 check inter 5s rise 1 fall 1" %>
<% end -%>

listen novncproxy
  bind <%=node['bcpc']['management']['vip']%>:6080 ssl crt /etc/haproxy/haproxy.pem
  balance source
  option tcpka
  option tcplog
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:6080 check inter 5s rise 1 fall 1" %>
<% end -%>

frontend http
  bind <%=node['bcpc']['management']['vip']%>:80
  option tcplog
  default_backend http-backend

frontend https
  bind <%=node['bcpc']['management']['vip']%>:443 ssl crt /etc/haproxy/haproxy.pem
  option tcplog
  stats enable
  stats uri /haproxy
  stats hide-version
  stats realm Haproxy\ Statistics
  stats auth <%=get_config('haproxy-stats-user')%>:<%=get_config('haproxy-stats-password')%>
  reqadd X-Forwarded-Proto:\ https
  acl url_horizon path_beg /horizon
  use_backend horizon-backend if url_horizon
  acl url_horizon_static path_beg /static
  use_backend horizon-backend if url_horizon_static
  acl url_rabbitmq path_beg /rabbitmq
  use_backend rabbitmq-web-backend if url_rabbitmq
  default_backend http-backend

backend http-backend
  balance source
  option httpchk GET /
  http-check expect status 200
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:80 check inter 5s rise 1 fall 1" %>
<% end -%>

backend horizon-backend
  balance source
  option httpchk GET /
  http-check expect status 200
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:9999 check inter 5s rise 1 fall 1" %>
<% end -%>

backend rabbitmq-web-backend
  balance source
  option httpchk GET /
  http-check expect status 200
  reqrep ^([^\ :]*)\ /rabbitmq/(.*) \1\ /\2
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:55672 check inter 5s rise 1 fall 1" %>
<% end -%>
