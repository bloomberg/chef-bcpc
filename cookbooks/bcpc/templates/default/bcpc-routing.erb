#!/bin/sh
################################################
#
#              Generated by Chef
#
################################################

# Add default routes as a safety net, then remove all at the end
ip route add default via <%=@node["bcpc"]["management"]["gateway"]%> \
         dev <%=@node["bcpc"]["management"]["interface"]%> \
         table main \
         proto static

ip route add <%=@node["bcpc"]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["management"]["interface"]%> \
         scope link src <%=@node["bcpc"]["management"]["ip"]%> \
         table main \
         proto static

ip route add <%=@node["bcpc"]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         scope link src <%=@node["bcpc"]["storage"]["ip"]%> \
         table main \
         proto static

# Build routing table for management network
ip route flush table mgmt
ip route add default via <%=@node["bcpc"]["management"]["gateway"]%> \
         dev <%=@node["bcpc"]["management"]["interface"]%> \
         table mgmt \
         proto static

ip route add <%=@node["bcpc"]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["management"]["interface"]%> \
         scope link src <%=@node["bcpc"]["management"]["ip"]%> \
         table mgmt \
         proto static

# Move the local table ip rule up further in the list
ip rule add from all lookup local pref 0
ip rule del pref 1000
ip rule add from all lookup local pref 1000
# Intentionally duplicated in case there are two present
ip rule del pref 0
ip rule del pref 0

<% if node['bcpc']['enabled']['secure_fixed_networks'] -%>
# Prevent any fixed network traffic from seeing our management and storage
# by skipping past the local table and using the main routing table
<% @mgm_pref = 100 %>
<% @stg_pref = 200 %>
ip rule del pref <%= @mgm_pref %>
ip rule del pref <%= @stg_pref %>
ip rule add from <%=@node["bcpc"]["fixed"]["cidr"]%> to <%=@node["bcpc"]["management"]["cidr"]%> pref <%= @mgm_pref %> table main
ip rule add from <%=@node["bcpc"]["fixed"]["cidr"]%> to <%=@node["bcpc"]["storage"]["cidr"]%> pref <%= @stg_pref %> table main
  <% if node["bcpc"]["additional_fixed"] -%>
    <% @pref = 200 %>
    <% @node["bcpc"]["additional_fixed"].each do |id,network| %>
# Prevent any <%= id %> network traffic from seeing our management and storage
# by skipping past the local table and using the main routing table
      <% @pref += 1 %>
ip rule del pref <%= @pref %>
ip rule add from <%= network["cidr"] %> to <%= @node["bcpc"]["management"]["cidr"] %> pref <%= @pref %> table main
      <% @pref += 1 %>
ip rule del pref <%= @pref %>
ip rule add from <%= network["cidr"] %> to <%= @node["bcpc"]["storage"]["cidr"] %> pref <%= @pref %> table main
    <% end %>
  <% end -%>
<% end -%>

# Let traffic to/from fixed IPs route via main table
<% @fixed_from_pref = 9000 %>
<% @fixed_to_pref = 9001 %>
ip rule del pref <%= @fixed_from_pref %>
ip rule del pref <%= @fixed_to_pref %>
ip rule add from <%= @node["bcpc"]["fixed"]["cidr"] %> pref <%= @fixed_from_pref %> table main
ip rule add to <%= @node["bcpc"]["fixed"]["cidr"] %> pref <%= @fixed_to_pref %> table main
<% if node["bcpc"]["additional_fixed"] -%>
  <% @fixed_pref = 9001 %>
  <% @node["bcpc"]["additional_fixed"].each do |id,network| %>
# Let traffic to/from <%= id %> IPs route via main table
    <% @fixed_pref += 1 %>
ip rule del pref <%= @fixed_pref %>
ip rule add from <%= network["cidr"] %> pref <%= @fixed_pref %> table main
    <% @fixed_pref += 1 %>
ip rule del pref <%= @fixed_pref %>
ip rule add to <%= network["cidr"] %> pref <%= @fixed_pref %> table main
  <% end %>
<% end -%>

# Activate this routing table for management traffic
ip rule del pref 10000
ip rule del pref 10001
ip rule add from <%=@node["bcpc"]["management"]["cidr"]%> pref 10000 table mgmt
ip rule add to <%=@node["bcpc"]["management"]["cidr"]%> pref 10001 table mgmt

# Build routing table for storage network
ip route flush table storage
ip route add default via <%=@node["bcpc"]["storage"]["gateway"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         table storage \
         proto static

ip route add <%=@node["bcpc"]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         scope link src <%=@node["bcpc"]["storage"]["ip"]%> \
         table storage \
         proto static

# Activate this routing table for storage traffic
ip rule del pref 10002
ip rule del pref 10003
ip rule add from <%=@node["bcpc"]["storage"]["cidr"]%> pref 10002 table storage
ip rule add to <%=@node["bcpc"]["storage"]["cidr"]%> pref 10003 table storage

# Drop all routes to other networks from the main routing table
# XXX: The following line is intentionally duplicated to remove multiple default routes
ip route del default dev <%=@node["bcpc"]["management"]["interface"]%> \
         table main
ip route del default dev <%=@node["bcpc"]["management"]["interface"]%> \
         table main
ip route del default dev <%=@node["bcpc"]["storage"]["interface"]%> \
         table main
ip route del <%=@node["bcpc"]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["management"]["interface"]%> \
         table main
ip route del <%=@node["bcpc"]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         table main

# Flush the route cache to make sure these are active
ip route flush cache
