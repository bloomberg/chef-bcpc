# for an overview of all the available configuration options for nova@pike
# go to: https://docs.openstack.org/cinder/pike/configuration/block-storage/samples/cinder.conf.html
#
[DEFAULT]
host = bcpc
storage_availability_zone =
allow_availability_zone_fallback = <%= node['bcpc']['cinder']['allow_az_fallback'] %>
rootwrap_config = /etc/cinder/rootwrap.conf
api_paste_confg = /etc/cinder/api-paste.ini
auth_strategy = keystone
state_path = /var/lib/cinder
log_dir=/var/log/cinder

enable_v1_api=false
enable_v2_api=true

transport_url = rabbit://<%= @servers.map{|x| 'guest:' + get_config('rabbitmq-password') + '@' + x['bcpc']['management']['ip'] + ":5672"}.join(',') %>
glance_api_servers = <%=node['bcpc']['protocol']['glance']%>://openstack.<%=node['bcpc']['cluster_domain']%>:9292
glance_api_insecure = true
enabled_backends = <%= node['bcpc']['ceph']['enabled_pools'].map {|type| type.upcase}.join(",") %>
enable_v3_api = true

rpc_backend = rabbit
rpc_response_timeout=<%= node['bcpc']['cinder']['rpc_response_timeout'] %>

glance_api_servers=<%=node['bcpc']['protocol']['glance']%>://openstack.<%=node['bcpc']['cluster_domain']%>:9292
glance_api_insecure=True
glance_api_version=2

enabled_backends=<%= node['bcpc']['ceph']['enabled_pools'].map {|type| type.upcase}.join(",") %>

[database]
connection = mysql+pymysql://<%=get_config('cinder-db-user')%>:<%=get_config('cinder-db-password')%>@<%=node['bcpc']['mysql-head']['service_hostname']%>/<%=node['bcpc']['dbname']['cinder']%>
max_overflow = <%= node['bcpc']['cinder']['database']['max_overflow'] %>
max_pool_size = <%= node['bcpc']['cinder']['database']['max_pool_size'] %>
idle_timeout = 3600


[oslo_concurrency]
lock_path = /var/lock/cinder


[keystone_authtoken]
www_authenticate_uri = <%=node['bcpc']['protocol']['keystone']%>://openstack.<%=node['bcpc']['cluster_domain']%>:5000
auth_url = <%=node['bcpc']['protocol']['keystone']%>://openstack.<%=node['bcpc']['cluster_domain']%>:35357
memcached_servers = <%= @servers.map{|x| x['bcpc']['management']['ip'] + ":11211"}.join(',') %>
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = <%= get_config('cinder-os-user') %>
password = <%= get_config('cinder-os-password') %>

<% node['bcpc']['ceph']['enabled_pools'].each do |type| -%>

[<%= type.upcase %>]
volume_driver = cinder.volume.drivers.rbd.RBDDriver
volume_backend_name = <%= type.upcase %>
rbd_user = cinder
rbd_pool = <%="#{node['bcpc']['ceph']['volumes']['name']}-#{type}"%>
rbd_secret_uuid = <%=get_config('libvirt-secret-uuid')%>
rbd_flatten_volume_from_snapshot = <%= node['bcpc']['cinder']['rbd_flatten_volume_from_snapshot'] %>
rbd_max_clone_depth = <%= node['bcpc']['cinder']['rbd_max_clone_depth'] %>
rbd_store_chunk_size = 4
rados_connect_timeout = -1
glance_api_version = 2
<% end -%>

