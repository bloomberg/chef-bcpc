################################################
#
#              Generated by Chef
#
################################################

# Changed MaxKeepAliveRequest from 100 to 0 to allow for maximum limit.
MaxKeepAliveRequests 0

# The below mpm_prefork_module settings can change based on environment resources/needs.
<IfModule mpm_prefork_module>
    ServerLimit          500
    StartServers         250
    MinSpareServers       50
    MaxSpareServers      200
    MaxClients           500
    MaxRequestsPerChild    0
</IfModule>

NameVirtualHost <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw']}"%>


Listen <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw']}"%>
Listen <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw_https']}"%>

FastCgiExternalServer /var/www/s3gw.fcgi -socket /var/lib/ceph/radosgw/rgw_fcgi.sock -idle-timeout 60

<VirtualHost  <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw']}"%> >
        ServerName <%="s3.#{node['bcpc']['domain_name']}"%>
        ServerAlias <%=node['hostname']%>
        ServerAlias <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw']}"%>
        ServerAdmin <%=node['bcpc']['admin_email']%>
        DocumentRoot /var/www

<% if node['bcpc']['enabled']['radosgw_cache'] -%>
        CacheEnable disk /
        CacheMaxFileSize <%="#{node['bcpc']['radosgw']['cache_max_file_size']}"%>
<% end -%>

        RewriteEngine On
        RewriteRule ^/([a-zA-Z0-9-_.]*)([/]?.*) /s3gw.fcgi?page=$1&params=$2&%{QUERY_STRING} [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L]
        <IfModule mod_fastcgi.c>
                <Directory /var/www>
                        Options +ExecCGI
                        AllowOverride All
                        SetHandler fastcgi-script
                        Order allow,deny
                        Allow from all
                        AuthBasicAuthoritative Off
                </Directory>
        </IfModule>
        AllowEncodedSlashes On
        ErrorLog /var/log/apache2/rgw_error.log
        CustomLog /var/log/apache2/rgw_access.log  "%h %l %u %t \"%r\" %>s %I/%O [%D] \"%{Referer}i\" \"%{User-Agent}i\""
        ServerSignature Off
</VirtualHost>

NameVirtualHost <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw_https']}"%>

<VirtualHost  <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw_https']}"%> >
        ServerName <%="s3.#{node['bcpc']['domain_name']}"%>
        ServerAlias <%=node['hostname']%>
        ServerAlias <%="#{node['bcpc']['floating']['ip']}:#{node['bcpc']['ports']['apache']['radosgw_https']}"%>
        ServerAdmin <%=node['bcpc']['admin_email']%>
        DocumentRoot /var/www

<% if node['bcpc']['enabled']['radosgw_cache'] -%>
        CacheEnable disk /
        CacheMaxFileSize <%="#{node['bcpc']['radosgw']['cache_max_file_size']}"%>
<% end -%>

        SSLEngine on
        SSLCertificateFile /etc/ssl/certs/ssl-bcpc.pem
        SSLCertificateKeyFile /etc/ssl/private/ssl-bcpc.key

        RewriteEngine On
        RewriteRule ^/([a-zA-Z0-9-_.]*)([/]?.*) /s3gw.fcgi?page=$1&params=$2&%{QUERY_STRING} [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L]
        <IfModule mod_fastcgi.c>
                <Directory /var/www>
                        Options +ExecCGI
                        AllowOverride All
                        SetHandler fastcgi-script
                        Order allow,deny
                        Allow from all
                        AuthBasicAuthoritative Off
                </Directory>
        </IfModule>
        AllowEncodedSlashes On
        ErrorLog /var/log/apache2/rgw_error.log
        CustomLog /var/log/apache2/rgw_access.log combined
        ServerSignature Off
</VirtualHost>

